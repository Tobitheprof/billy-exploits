import requests
from helpers.constants import headers, BASE_URL
from helpers.functions import id_generator


class ChatSessionManager:
    def __init__(self, user_id):
        self.user_id = user_id
        self.base_url = BASE_URL
        self.headers = headers

    def retrieve_chat(self, chat_id):
        """Retrieve chat using the chat_id."""
        path = "/retrieve-chat"
        data = {
            "user_id": self.user_id,
            "chat_id": chat_id
        }

        response = requests.post(self.base_url + path, headers=self.headers, json=data)
        if response.status_code == 200:
            print(f"Successfully retrieved chat for {data['chat_id']}")
            print(response.text)
        else:
            print(f"Failed to retrieve chat: {response.text}")
        
        return response.text

    def post_chat(self, messages=None, name="Main Chat", sql_query=""):
        """Generate a new chat session with optional messages."""
        path = "/post-chats"
        chat_id = id_generator()
        data = {
            "user_id": self.user_id,
            "messages": messages if messages else "[]",  # default to empty array if no messages provided
            "name": name,
            "sql_query": sql_query,
            "chat_id": chat_id
        }

        response = requests.post(self.base_url + path, headers=self.headers, json=data)

        if response.status_code == 200:
            print(f"Successfully generated chat with ID: {data['chat_id']}")
            print(response.text)
            self.retrieve_chat(data['chat_id'])
        else:
            print(f"Failed to generate chat: {response.text}")
        
        return response.status_code


# Usage example
if __name__ == "__main__":
    user_id = "0b291a92-1bbc-4df2-ac3d-f36c9e0b1a0b"
    chat_manager = ChatSessionManager(user_id)

    # Post a new chat session
    chat_manager.post_chat(messages="[{'role':'user', 'input':'What is 2+2'}]", name="Test Chat")
